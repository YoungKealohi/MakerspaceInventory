extends layout

block content
  .login-button-container
    a.button-login-home(href="/login") Login

  .top-row-flex(style="display: flex; flex-direction: row; align-items: flex-start; justify-content: center; gap: 48px; margin-top: 32px;")
    .machine-status-panel(style="flex: 1; min-width: 320px; max-width: 480px; display: flex; flex-direction: column; align-items: center;")
      h2.homepage-title Machine Status
      if machines && machines.length > 0
        table.machine-status-table(style="margin: 0 auto;")
          thead
            tr
              th Machine Name
              th Status
          tbody
            each machine in machines
              tr
                td.machine-name-cell= machine.MachineName
                td.status-cell
                  if machine.WorkingStatus
                    span.status-available(style="color: green; font-weight: bold;") Available
                  else
                    span.status-unavailable(style="color: red; font-weight: bold;") Unavailable
      else
        p.no-machines No machines available.
    .worker-schedule-panel(style="flex: 1; min-width: 320px; max-width: 480px; display: flex; flex-direction: column; align-items: center;")
      h2.schedule-title Worker Schedule
      .schedule-nav(style="display: flex; justify-content: center; align-items: center; gap: 16px; margin-bottom: 8px;")
        button#prevDay.nav-button(type="button") ◀ Previous Day
        .day-info
          span#currentDay.schedule-day-label= currentWeekday
        button#nextDay.nav-button(type="button") Next Day ▶
      if schedule && schedule.length > 0
        table.schedule-table(style="margin: 0 auto;")
          thead
            tr
              th Name
              th Specialty
              th Time
          tbody
            each worker in schedule
              tr
                td.worker-name-cell= worker.FirstName + ' ' + worker.LastName
                td.worker-specialty-cell= worker.specialties || '—'
                td.worker-time-cell= worker.StartTime + ' - ' + worker.EndTime
      else
        p.no-schedule No workers scheduled today.

  script.
    let currentDayOffset = 0; // 0 = today, -1 = yesterday, +1 = tomorrow, etc.
    
    // Helper to skip weekends
    function getNextWeekdayOffset(currentOffset, direction) {
      let newOffset = currentOffset;
      
      // Keep moving in the direction until we hit a weekday
      do {
        newOffset += direction;
        const today = new Date();
        const targetDate = new Date(today);
        targetDate.setDate(today.getDate() + newOffset);
        const dayOfWeek = targetDate.getDay();
        
        // Check if it's a weekday (1=Monday to 5=Friday)
        if (dayOfWeek >= 1 && dayOfWeek <= 5) {
          return newOffset;
        }
      } while (true);
    }
    
    function updateSchedule(dayOffset) {
      currentDayOffset = dayOffset;
      
      // Fetch schedule for the selected day
      fetch(`/api/schedule?dayOffset=${dayOffset}`)
        .then(response => response.json())
        .then(data => {
          // Update the day label
          document.getElementById('currentDay').textContent = data.weekdayName;
          
          // Update the schedule table
          const schedulePanel = document.querySelector('.worker-schedule-panel');
          const existingTable = schedulePanel.querySelector('.schedule-table');
          const existingMessage = schedulePanel.querySelector('.no-schedule');
          
          if (data.schedule && data.schedule.length > 0) {
            // Remove "no schedule" message if it exists
            if (existingMessage) {
              existingMessage.remove();
            }
            
            // Build the table HTML
            let tableHTML = `
              <table class="schedule-table" style="margin: 0 auto;">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Specialty</th>
                    <th>Time</th>
                  </tr>
                </thead>
                <tbody>
            `;
            
            data.schedule.forEach(worker => {
              tableHTML += `
                <tr>
                  <td class="worker-name-cell">${worker.FirstName} ${worker.LastName}</td>
                  <td class="worker-specialty-cell">${worker.specialties || '—'}</td>
                  <td class="worker-time-cell">${worker.StartTime} - ${worker.EndTime}</td>
                </tr>
              `;
            });
            
            tableHTML += '</tbody></table>';
            
            // Replace or insert the table
            if (existingTable) {
              existingTable.outerHTML = tableHTML;
            } else {
              schedulePanel.insertAdjacentHTML('beforeend', tableHTML);
            }
          } else {
            // Remove table if it exists
            if (existingTable) {
              existingTable.remove();
            }
            
            // Show "no schedule" message
            if (!existingMessage) {
              schedulePanel.insertAdjacentHTML('beforeend', '<p class="no-schedule">No workers scheduled today.</p>');
            }
          }
        })
        .catch(error => {
          console.error('Error fetching schedule:', error);
        });
    }
    
    // Button event listeners
    document.getElementById('prevDay').addEventListener('click', () => {
      const newOffset = getNextWeekdayOffset(currentDayOffset, -1);
      updateSchedule(newOffset);
    });
    
    document.getElementById('nextDay').addEventListener('click', () => {
      const newOffset = getNextWeekdayOffset(currentDayOffset, 1);
      updateSchedule(newOffset);
    });

