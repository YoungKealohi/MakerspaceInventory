extends layout

block content

  .top-row-flex(style="display: flex; flex-direction: row; align-items: flex-start; justify-content: center; gap: 48px; margin-top: 32px;")
    .machine-status-panel(style="flex: 1; min-width: 320px; max-width: 480px; display: flex; flex-direction: column; align-items: center;")
      h2.homepage-title Machine Status
      if machines && machines.length > 0
        table.machine-status-table(style="margin: 0 auto;")
          thead
            tr
              th Machine Name
              th Status
          tbody
            each machine in machines
              tr
                td.machine-name-cell= machine.MachineName
                td.status-cell
                  if machine.WorkingStatus
                    span.status-available(style="color: green; font-weight: bold;") Available
                  else
                    span.status-unavailable(style="color: red; font-weight: bold;") Unavailable
      else
        p.no-machines No machines available.
    .worker-schedule-panel(style="flex: 1; min-width: 400px; max-width: 600px; display: flex; flex-direction: column; align-items: stretch;")
      h2.schedule-title Worker Schedule
      .schedule-nav
        button#prevDay.nav-button(type="button") ◀ Previous Day
        .day-info
          span#currentDay.schedule-day-label= currentWeekday
        button#nextDay.nav-button(type="button") Next Day ▶
      if schedule && schedule.length > 0
        table.schedule-table(style="margin: 0 auto;")
          thead
            tr
              th Name
              th Specialty
              th Time
          tbody
            each worker in schedule
              tr
                td.worker-name-cell= worker.FirstName
                td.worker-specialty-cell= worker.specialties || '—'
                td.worker-time-cell= worker.StartTime + ' - ' + worker.EndTime
        p *All workers are trained on all machines.
      else
        p.no-schedule No workers scheduled today.

  // Separate Makerspace Hours section - now outside worker-schedule-panel
  .makerspace-hours-container(style="display: flex; justify-content: center; margin-top: 32px;")
    .makerspace-hours(style="max-width: 600px;")
      h3 Makerspace Hours
      table
        tbody
          - const days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday']
          each day in days
            tr
              td.mh-label #{day}:
              td.mh-time
                - const hours = makerspaceHours && makerspaceHours[day]
                if hours && hours.open !== 'Closed'
                  | #{hours.open}-#{hours.close}
                else
                  | Closed

  //- Script: schedule positioning and update handlers
  script.
    let currentDayOffset = 0; // 0 = today, -1 = yesterday, +1 = tomorrow, etc.

    function positionScheduleNav() {
      // Keep a hook for future adjustments, but do not set left/width or
      // panel padding. The nav should flow with document layout so it
      // scrolls with content and does not require absolute positioning.
      const schedulePanel = document.querySelector('.worker-schedule-panel');
      const scheduleNav = document.querySelector('.schedule-nav');
      if (!schedulePanel || !scheduleNav) return;

      // No inline layout mutations here. If needed later we can compute
      // measurements to tweak CSS, but for now let CSS control sizing.
    }

    // Run on DOM ready and after small delays to catch font/layout shifts
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        positionScheduleNav();
        setTimeout(positionScheduleNav, 200);
      });
    } else {
      positionScheduleNav();
      setTimeout(positionScheduleNav, 200);
    }

    // Debounced resize
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(positionScheduleNav, 120);
    });

    // Helper to skip weekends (Sunday=0, Saturday=6)
    function getNextWeekdayOffset(currentOffset, direction) {
      let newOffset = currentOffset;
      do {
        newOffset += direction;
        const today = new Date();
        const targetDate = new Date(today);
        targetDate.setDate(today.getDate() + newOffset);
        const dayOfWeek = targetDate.getDay();
        // Monday=1, Tuesday=2, Wednesday=3, Thursday=4, Friday=5
        if (dayOfWeek !== 0 && dayOfWeek !== 6) return newOffset;
      } while (true);
    }

    function updateSchedule(dayOffset) {
      currentDayOffset = dayOffset;
      fetch(`/api/schedule?dayOffset=${dayOffset}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById('currentDay').textContent = data.weekdayName;
          const schedulePanel = document.querySelector('.worker-schedule-panel');
          const existingTable = schedulePanel.querySelector('.schedule-table');
          const existingMessage = schedulePanel.querySelector('.no-schedule');

          if (data.schedule && data.schedule.length > 0) {
            if (existingMessage) existingMessage.remove();
            let tableHTML = `
              <table class="schedule-table" style="margin: 0 auto;">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Specialty</th>
                    <th>Time</th>
                  </tr>
                </thead>
                <tbody>`;
            data.schedule.forEach(worker => {
              tableHTML += `
                <tr>
                  <td class="worker-name-cell">${worker.FirstName}</td>
                  <td class="worker-specialty-cell">${worker.specialties || '—'}</td>
                  <td class="worker-time-cell">${worker.StartTime} - ${worker.EndTime}</td>
                </tr>`;
            });
            tableHTML += '</tbody></table>';
            if (existingTable) existingTable.outerHTML = tableHTML; else schedulePanel.insertAdjacentHTML('beforeend', tableHTML);
          } else {
            if (existingTable) existingTable.remove();
            if (!existingMessage) schedulePanel.insertAdjacentHTML('beforeend', '<p class="no-schedule">No workers scheduled today.</p>');
          }
        })
        .catch(error => console.error('Error fetching schedule:', error));
    }

    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'prevDay') {
        const newOffset = getNextWeekdayOffset(currentDayOffset, -1);
        updateSchedule(newOffset);
      }
      if (e.target && e.target.id === 'nextDay') {
        const newOffset = getNextWeekdayOffset(currentDayOffset, 1);
        updateSchedule(newOffset);
      }
    });

  // (removed duplicate bottom Makerspace hours - moved into schedule panel)
  // Footer contact
  p(style="text-align: center; margin: 30px 0; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.4);")
    | For questions, please contact 
    a(href="mailto:makerspace@hpu.edu" style="color: #fff; text-decoration: underline;") makerspace@hpu.edu
